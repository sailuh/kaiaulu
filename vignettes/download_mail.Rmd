---
title: "Download Mod Mbox and Pipermail Mailing List Archives"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Download Mod Mbox Mailing List Archives}
  %\VignetteEncoding{UTF-8}
---


```{r warning = FALSE, message = FALSE}
rm(list = ls())
seed <- 1
set.seed(seed)

# Load libraries
require(kaiaulu)
require(data.table)
require(yaml)
require(stringi)
require(XML)
require(httr)
require(gt)
```


# Introduction

Open source projects require a means for developers to communicate. These may include mailing lists, issue trackers, discord, etc. This notebooks showcases how to download data from mailing list **archives**. 

Mailing lists are typically organized by topic or purpose. For example, the [OpenSSL project](https://www.openssl.org/community/mailinglists.html) maintains several mailing lists, each serving a different purpose:

- **project-announce**: For important announcements.
- **project-commits**: For commit messages.
- **project-project**: For project discussions.
- **project-users**: For general user questions and discussions.

The same mailing list, such as **project-users** may be stored in different **archives**. For example, there may be two archive mailing lists covering different time ranges. The data may overlap, or be incomplete depending on the archive type. Sometimes, each **archive** may come in a different format, communication may result from bots, etc. Different formats require different code to both download and parse them. Therefore, if the intent is to obtain a comprehensive understanding of the mailing list communication of a project, manual inspection of the available archives and their time range is **strongly** recommended. 

Careful manual inspection of the mailing list data of particular importance when using Kaiaulu metrics such as social smells, where a incomplete mailing list archive will result in erroneous metric calculation (i.e. absence of communication reported in a metric when developing a feature being due to missing data, instead not ocuring within the data). 

# Mailing List Organization

Two often used archive types are [mod_mbox](https://httpd.apache.org/mod_mbox/) and [pipermail](https://en.wikipedia.org/wiki/GNU_Mailman#cite_note-9), which Kaiaulu offer functions to download data from. The former is commonly used by the Apache Software Foundation projects, such as [Apache Geronimo](https://geronimo.apache.org/mailing-lists.html). The latter, is more commonly use in GNU related projects, such as [OpenSSL](https://mta.openssl.org/mailman/listinfo/), but this can vary. 

Mod Mbox archives also organize mailing lists by topic. The apache mailing list archives can be found at https://lists.apache.org/.

This notebook demonstrates how to download and refresh mailing list archives from Mod Mbox and Pipermail.

# Project Configuration File 

Mailing List archives are hosted by their respective open source projects. Therefore, in order to use Kaiaulu downloaders to obtain mail data, you will need to access the respective open source project, and find out the URL tied to the archive you are interested in. Generally, that is the **developer** mailing list, if your interest is to understand communication patterns among developers. Alternatively, if the focus of the research is Q&A from the user base, then a **user** mailing list may make more sense.

Because project lifetime can go as far as a few decades, to have the full picture of what communication took place in the project you may need to download multiple archives and combine them, after turning them into tables using the Kaiaulu parser.

The information you need to find out for each open source project is documented in Kaiaulu using a project configuration file format. For pipermail and mod_mbox this is as follows:

```
mailing_list:
  # for pipermail
  pipermail:
    project_key_1:
      mailing_list: https://mta.openssl.org/pipermail/openssl-users/
      save_folder_path: ../../rawdata/helix/pipermail/save_mbox_mail
  # for mod mbox
  mod_mbox:
    project_key_1:
      mailing_list: https://lists.apache.org/list.html?announce@apache.org
      save_folder_path: ../../rawdata/helix/mod_mbox/save_mbox_mail
```

The most manual time intensive step you will be required is to locate the URL of the mailing list archive you wish for in the project website. Once located, this is specified in Kaiaulu's project configuration file under `mailing_list`. Note for pipermail this URL should point to the page containing links to the monthly archives (e.g. https://mta.openssl.org/pipermail/openssl-users/), not the top-level mailing list page that contains all the different types of archives (e.g. https://mta.openssl.org/mailman/listinfo/).


Regardless of which mail archive you choose, the downloaders will store the mail data in monthly files, in a `.mbox` format. This is a simple text file that contains some markings to identify the header of the e-mail containing title, authors, etc. While you can open any of the .mbox downloaded files with any text editor, Kaiaulu parsers will format them into tables, as demonstrated below. 

## Tools Configuration

In addition to the mailing list configurations, you need to specify the path to the [Perceval](https://github.com/chaoss/grimoirelab-perceval) binary in your computer in Kaiaulu's tools.yml. This is so Kaiaulu can make a system call to the tool to parse the data. See the wiki for further details on how to setup third party tools. 

```{r}
# Load tools configuration
tools <- parse_config("../tools.yml")
parse_perceval_path <- get_tool_project("perceval", tools)

# Load project configuration
conf <- parse_config("../conf/helix.yml")
mbox_file_path <- get_mbox_path(conf, "project_key_1")
```

# Downloaders and Refreshers

## Downloaders

With the configurations loaded, we can proceed to download the mailing list archives. The downloaders are responsible for fetching the archives from the specified mailing lists and saving them locally in .mbox format.

### Pipermail Downloader

For Pipermail, we need to specify the project key, which is used to retrieve the configuration parameters for the specific project. The project key is used to identify the project in the configuration file.

Now, we can use the getter functions to retrieve the configuration parameters for the specified project key.

```{r}
conf <- parse_config("../conf/openssl.yml")
pipermail_mailing_list <- get_pipermail_domain(conf, "project_key_1")
pipermail_save_folder_path <- get_pipermail_path(conf, "project_key_1")

# Define the date range
pipermail_start_year_month <- 202310
pipermail_end_year_month <- 202405
```

With our configurations loaded, we can proceed to downloading the mailing list archives.

```{r eval=FALSE}
# Download archives
download_pipermail(
  mailing_list = pipermail_mailing_list,
  start_year_month = pipermail_start_year_month,
  end_year_month = pipermail_end_year_month,
  save_folder_path = pipermail_save_folder_path,
  verbose = TRUE
)

```

After running this function, the .mbox files will be saved in the specified directory with filenames like 202310.mbox, 202311.mbox, etc, which can be parsed in a table:

```{r}
parsed_mail <- parse_mbox(
  perceval_path = parse_perceval_path,
  mbox_file_path = pipermail_save_folder_path
)

parsed_mail %>%
  head(10) %>%
  gt()
```

### Mod Mbox Downloader

The download_mod_mbox() function downloads Mod Mbox archives from a specified Apache Pony Mail mailing list over a given date range. We obtain the required parameters from the project configuration file, as done before:

```{r eval=FALSE}
conf <- parse_config("../conf/helix.yml")
mbox_mailing_list <- get_mbox_domain(conf, "project_key_1")
mbox_save_folder_path <- get_mbox_path(conf, "project_key_1")

# Define the date range
mbox_start_year_month <- 202310
mbox_end_year_month <- 202405
```


The `start_year_month` and `end_year_month` time range parameters should be set manually, as with Pipermail.


```{r eval=FALSE}
download_mod_mbox(
  mailing_list = mbox_mailing_list,
  start_year_month = mbox_start_year_month,
  end_year_month = mbox_end_year_month,
  save_folder_path = mbox_save_folder_path,
  verbose = TRUE
  )

```

After running the function, it constructs URLs like: https://lists.apache.org/api/mbox.lua?list=announce@apache.org&date=2024-01
and saves the files in the specified folder.

```{r}
parsed_mail <- parse_mbox(
  perceval_path = parse_perceval_path,
  mbox_file_path = mbox_file_path
)

parsed_mail %>%
  head(10) %>%
  gt()
```

# Refreshers

Kaiaulu offers convenient function to add new e-mails since the last execution of the downloaders. These are defined as "refresh_*" functions. The most recent file name's timestamp, which captures the latest month, is used as a starting date to download new files. The most recent file is deleted and re-downloaded to ensure all e-mails of the last month were downloaded, and subsequent files are then downloaded.

### Pipermail Refresher

```{r eval=FALSE}
# Refresh archives
refresh_pipermail(
  mailing_list = pipermail_mailing_list,
  start_year_month = pipermail_start_year_month,
  save_folder_path = pipermail_save_folder_path,
  verbose = TRUE
)
```

### Mod Mbox Refresher

A similar function is also available for mod_mbox:

```{r eval=FALSE}
refresh_mod_mbox(
  mailing_list = mbox_mailing_list,
  # start_year_month = mbox_start_year_month,
  save_folder_path = mbox_save_folder_path,
  verbose = TRUE
)
```

