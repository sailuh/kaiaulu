---
title: "Download Mod Mbox and Pipermail Mailing List Archives"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Download Mod Mbox Mailing List Archives}
  %\VignetteEncoding{UTF-8}
---


```{r}
rm(list = ls())
seed <- 1
set.seed(seed)

# Load libraries
  require(kaiaulu)
  require(data.table)
  require(yaml)
  require(stringi)
  require(XML)
  require(httr)
```


# Introduction

Mailing list data is stored in a variety of archives. See:
- Mod Mbox: [Apache Geronimo](https://geronimo.apache.org/mailing-lists.html)).
- Pipermail: [OpenSSL](https://mta.openssl.org/mailman/listinfo/).
This notebook demonstrates how to download and refresh mailing list archives from Mod Mbox and Pipermail.

# Pipermail

## Mailing List Organization

Mailing lists are typically organized by topic or purpose. For example, the [OpenSSL project](https://www.openssl.org/community/mailinglists.html) maintains several mailing lists, each serving a different group:

- **openssl-announce**: For important announcements.
- **openssl-commits**: For commit messages.
- **openssl-project**: For project discussions.
- **openssl-users**: For general user questions and discussions.

Each mailing list maintains archives of past messages, often organized by month and year. These archives can be accessed and downloaded for analysis.

## Project Configuration File 

To start, we load the project configuration file, which contains parameters for downloading the mailing list archives.

```{r}
conf <- yaml::read_yaml("../conf/helix.yml")
mailing_list <- conf[["mailing_list"]][["pipermail"]][["project_key_1"]][["mailing_list"]]
start_year_month <- conf[["mailing_list"]][["pipermail"]][["project_key_1"]][["start_year_month"]]
end_year_month <- conf[["mailing_list"]][["pipermail"]][["project_key_1"]][["end_year_month"]]
save_folder_path <- conf[["mailing_list"]][["pipermail"]][["project_key_1"]][["save_folder_path"]]
```

### Explanation of Configuration Parameters
- mailing_list: The URL of the mailing list archive index page (e.g., https://lists.openssl.org/pipermail/openssl-users/).
- start_year_month: The starting date for downloading archives (in YYYYMM format).
- end_year_month: The ending date for downloading archives (in YYYYMM format).
- save_folder_path: The local directory where the downloaded archives will be saved.

## Pipermail Downloader
You can download the archives using the download_pipermail() function, which downloads and saves .mbox files to the specified directory. The .mbox files are named with the format kaiaulu_YYYYMM.mbox, where YYYYMM refers to the year and month of the archive.
```{r}
# Download archives
download_pipermail(
  mailing_list = mailing_list,
  start_year_month = start_year_month,
  end_year_month = end_year_month,
  save_folder_path = save_folder_path,
  verbose = TRUE
)

```
After running this function, the .mbox files will be saved in the specified directory with filenames like kaiaulu_202310.mbox, kaiaulu_202311.mbox, etc.

## Pipermail Refresher
In some cases, you may want to refresh the archive to ensure the most recent months are up-to-date or to handle updates to the mailing list. The refresh_pipermail() function helps automate this process.

How refresh_pipermail Works
1. Checks if the folder is empty: If the folder is empty, it downloads archives starting from start_year_month to the current month using download_pipermail().
2. Finds the most recent file: If the folder is not empty, the function checks for the most recent monthâ€™s file (based on the filename) and deletes it.
3. Redownloads from the most recent month: The function then redownloads the archive from the most recent month up to the current month.
```{r}
# Refresh archives
refresh_pipermail(
  mailing_list = mailing_list,
  start_year_month = start_year_month,
  save_folder_path = save_folder_path,
  verbose = TRUE
)

```
This function will ensure that the most recent archives are always up-to-date by redownloading the current month's archive if necessary and adding any new months that have been added to the mailing list.

# Mod Mbox

## Mailing List Organization
Mod Mbox archives also organize mailing lists by topic. The apache mailing list archives can be found at https://lists.apache.org/.

## Project Configuration File
Similar to Pipermail, we load the configuration for Mod Mbox from the YAML file, which includes the mailing list URL, the date range, and the save folder path.

```{r}
mod_mbox_list <- conf[["mailing_list"]][["mod_mbox"]][["project_key_1"]][["mailing_list"]]
mod_start_year_month <- conf[["mailing_list"]][["mod_mbox"]][["project_key_1"]][["start_year_month"]]
mod_end_year_month <- conf[["mailing_list"]][["mod_mbox"]][["project_key_1"]][["end_year_month"]]
mod_save_folder_path <- conf[["mailing_list"]][["mod_mbox"]][["project_key_1"]][["save_folder_path"]]
```

### Explanation of Configuration Parameters
- mailing_list: The URL of the Mod Mbox mailing list (e.g., https://lists.apache.org/list.html?announce@apache.org).
- start_year_month: The first month to download (format: YYYYMM).
- end_year_month: The last month to download (format: YYYYMM).
- save_folder_path: The directory where the downloaded .mbox files will be saved.

## Mod Mbox Downloader
The download_mod_mbox() function downloads Mod Mbox archives by constructing URLs based on the mailing list and date range, saving them as .mbox files named kaiaulu_YYYYMM.mbox.

```{r}
download_mod_mbox(
  mailing_list = mod_mbox_list,
  start_year_month = mod_start_year_month,
  end_year_month = mod_end_year_month,
  save_folder_path = mod_save_folder_path,
  verbose = TRUE
  )
```

After running the function, it constructs URLs like: https://lists.apache.org/api/mbox.lua?list=announce@apache.org&date=2024-01
and saves the files in the specified folder.

## Mod Mbox Refresher
To refresh these archives to ensure that you have the latest messages, you can use the refresh_mod_mbox function. This function works similarly to the Pipermail refresher.

How refresh_mod_mbox Works
1. Checks if the folder is empty and, if so, downloads the archives starting from start_year_month to the current month by calling download_mod_mbox().
2. If the folder contains files, it identifies the most recent one using the YYYYMM found in the filename. This file is deleted, and then redownloaded along with all future months.

```{r}
refresh_mod_mbox(
  mailing_list = mod_mbox_list,
  start_year_month = mod_start_year_month,
  save_folder_path = mod_save_folder_path,
  verbose = TRUE
)
```

This ensures your archive is up-to-date, accounting for new data that may have been added to the mailing list since the last download.

# Parser

After downloading the mailing list archives as .mbox files, the next step is to parse these files to extract meaningful information for analysis. The parse_mbox() function utilizes the Perceval library to parse .mbox files and convert them into structured data tables. This enables easier manipulation and analysis of mailing list data.

## Mbox Parser
The parse_mbox() function takes an .mbox file and parses it into a structured data.table using the Perceval library. 

For the configuration, make sure you have the correct path to the Perceval library in the conf file.

```{r}
tools_config <- yaml::read_yaml("../tools.yml")
parse_perceval_path <- tools_config[["perceval"]]

conf <- yaml::read_yaml("../conf/helix.yml")
parse_mbox_path <- conf[["mailing_list"]][["mod_mbox"]][["project_key_1"]][["save_folder_path"]]
```
Run the function using this:
```{r}
parsed_mail <- parse_mbox(
  perceval_path = parse_perceval_path,
  mbox_path = parse_mbox_path
)
```
This will store the parsed data into the parsed_mail variable. To view the table, use:
```{r}
View(parsed_mail)
```
